# schematic-ai-review

电路图片 → 结构化电路 JSON → LLM 生成 Markdown 评审报告，并在前端以 SVG overlay 进行人工复核的人机协同工作流。本项目为本地开发骨架，前后端分离，便于快速集成与二次开发。

## 重要必读（强提醒）

请将系统提示词和每轮视觉识别的专用提示词放入 `ReviewAIPrompt/` 目录（首选）。这些提示词文件在运行时为必需且不得为空；若任一必需提示词文件缺失或为空，后端将抛出 Error 并快速失败（fail fast）。

必需文件（必须存在且非空）：

- `ReviewAIPrompt/系统提示词.md`（中文） — 系统级提示词（系统提示词接口支持回退到仓库根目录）
- `ReviewAIPrompt/SystemPrompt.md`（英文） — 系统级提示词（系统提示词接口支持回退到仓库根目录）
- `ReviewAIPrompt/single_pass_vision_prompt.md` — 单轮通用视觉提示词
- `ReviewAIPrompt/macro_prompt.md` — 宏观识别（pass=1）
- `ReviewAIPrompt/ic_prompt.md` — IC 专项识别（pass=2）
- `ReviewAIPrompt/rc_prompt.md` — 阻容识别（pass=3）
- `ReviewAIPrompt/net_prompt.md` — 网路追踪（pass=4）
- `ReviewAIPrompt/verify_prompt.md` — 验证/整合（pass=5）
- `ReviewAIPrompt/consolidation_prompt.md` — 整合提示词（由后端合并器使用）

向后兼容：仅系统提示词接口在 `ReviewAIPrompt/` 缺失时会回退到根目录 `系统提示词.md` / `SystemPrompt.md`；但专用视觉提示词必须位于 `ReviewAIPrompt/`。

如需可直接使用的系统提示词，请联系作者付费获取：`gyrych@gmail.com`

## 特性

- 将电路图片解析为结构化 JSON，遵循 `backend/schemas/circuit-schema.json`
- 提供 SVG overlay 与映射，前端可高亮组件/引脚/网络便于人工核对
- 结合 LLM 生成 Markdown 评审报告，支持 timeline、requirements/specs、history 与 system prompt 注入
- 对不确定参数进行 Web 搜索丰富化（默认 DuckDuckGo）
- 支持本地会话保存/加载（包含文件 base64、enrichedJson、overlay），不持久化敏感凭据
- 文件日志便于诊断排错

## 架构（已更新）

- `frontend/` — Vite + React + TypeScript + Tailwind（开发端口 3000）。
- `services/circuit-agent/` — 独立后端子服务（默认端口 4001），所有接口统一在 `/api/v1/circuit-agent/*`。
- `backend/` — 已废弃。请改用子服务。

## 快速开始（子服务）

前置条件：Node.js ≥ 18

1）启动子服务

```
cd services/circuit-agent
npm install
# 默认端口：4001（可用 PORT 覆盖）
npm run dev
```

2）启动前端（新终端）

```
cd frontend
npm install
npm run dev
```

访问 http://localhost:3000（开发环境）。前端将调用子服务 `/api/v1/circuit-agent/*`。

Windows 一键：在仓库根目录执行 `start-all.bat`（或 `node start-all.js`）。

## 配置

- 系统提示词与每轮视觉提示词：请将必需文件放置于 `ReviewAIPrompt/`（参见上方“必需文件”）。仅当系统提示词缺失时，接口可能回退到根目录；但专用视觉提示词必须存在于 `ReviewAIPrompt/`。
- 上游模型：推荐使用 OpenRouter，子服务会将你的 Authorization 头转发到 OpenRouter。
- 环境变量（子服务）：见 `services/circuit-agent/.env.example`
  - `PORT`, `OPENROUTER_BASE`, `REDIS_URL`
  - `LLM_TIMEOUT_MS`, `VISION_TIMEOUT_MS`, `FETCH_RETRIES`, `KEEP_ALIVE_MSECS`
  - `STORAGE_ROOT`

## API 概要（子服务）

基础路径：`/api/v1/circuit-agent`

- 健康检查：`GET /health`
- 进度：`GET /progress/:id`
- 工件（静态）：`GET /artifacts/:filename`
- Logo（静态）：`GET /logo/*`
- 系统提示词：`GET /system-prompt?lang=zh|en`
- 统一编排：`POST /orchestrate/review`（multipart）— 通过 `directReview` 切换直评/精细
- 精细识别：`POST /modes/structured/recognize`（multipart）
- 多模型评审：`POST /modes/structured/review`（json）
- 最终整合（gpt-5）：`POST /modes/structured/aggregate`（multipart）
- 会话：`POST /sessions/save`、`GET /sessions/list`、`GET /sessions/:id`、`DELETE /sessions/:id`

说明：OCR 功能已移除。如需要 OCR，请在提交前独立处理。

## 故障排查

- 缺少系统提示词：确认 `ReviewAIPrompt/` 下文件存在且非空。
- 上游返回 HTML/404：检查 OpenRouter 路径与模型名（如 `/api/v1/chat/completions`）。
- 端口冲突：前端 3000，子服务 4001。
- 结构化识别返回 422：表示低置信或冲突，需要人工复核。

## 安全与隐私

- 会话保存会剔除敏感授权字段，日志不记录机密信息。主要用于本地开发与验证。

## 许可

- 如需对外分发或开源，请补充合适的许可证（LICENSE）。
