# Feature Specification: 单次交互的搜索轮与摘要轮

**Feature Branch**: `005-single-shot-search-summary`
**Created**: 2025-10-26
**Status**: Draft
**Input**: User description: "当前项目的单agent模式后端代码中搜索轮、摘要轮是通过多次与大模型交互来实现的，但是我看了openrouter的这份官方文档，应该是只需要一次交互就可以实现，请帮我按照官方文档的意图来修改搜索轮和摘要轮的实现方式：---"

## User Scenarios & Testing (mandatory)

### User Story 1 - 单轮完成“搜索+摘要” (Priority: P1)

系统在单 Agent 模式执行任务时，针对用户提问或目标，发起一次模型交互（开启网页搜索能力），模型在同一响应中返回综合回答（包含搜索取证后的摘要）与标准化引用标注（URL 引用）。系统将该响应作为本轮输出，并保留引用供后续展示与审计。

**Why this priority**: 直接减少与模型的往返次数，降低延迟与成本，同时对齐官方“单次交互+Web Search”能力。

**Independent Test**: 通过后端触发一次“搜索轮”调用，验证仅发生一次模型请求，响应包含内容与引用，并被系统成功保存与返回。

**Acceptance Scenarios**:

1. Given 单 Agent“搜索+摘要”被触发，When 系统发起单次带 Web 搜索能力的模型请求，Then 响应包含综合回答与至少0个引用标注，且系统返回该响应并记录引用。
2. Given 引擎选择为“原生/Exa/自动”，When 发起请求，Then 系统按配置使用对应引擎完成单次请求并得到标准化引用（若有）。

---

### User Story 2 - 前端同时展示摘要与引用 (Priority: P1)

前端在同一结果卡片中展示综合回答文本，并以域名样式的可点击标注展示引用来源列表。用户可查看引用并进行跳转。

**Why this priority**: 合并后的一次交互应提供完整可阅读与可追溯的结果体验。

**Independent Test**: 模拟一次请求，验证前端展示回答与引用，链接可正常打开，引用数量与顺序与后端一致。

**Acceptance Scenarios**:

1. Given 前端接收到包含引用的响应，When 渲染结果，Then 展示综合回答与域名命名的引用链接。
2. Given 响应无引用，When 渲染结果，Then 清晰标识“无引用”且不影响阅读。

---

### User Story 3 - 自动引擎选择与可控上下文规模/结果数 (Priority: P2)

系统应自动选择 Web 搜索引擎（支持原生则用原生，否则使用 Exa），不对用户暴露引擎配置项。同时，维护者可配置最大结果数与搜索上下文规模（低/中/高），以在成本与质量间平衡。

**Why this priority**: 不同场景对成本、速度与查全率的取舍不同，需要可控的策略。

**Independent Test**: 通过配置覆盖测试（引擎、max_results、上下文规模），验证单次请求行为与响应符合预期并被记录。

**Acceptance Scenarios**:

1. Given 系统自动选择引擎且无引擎用户配置项，When 触发“搜索+摘要”，Then 使用原生能力（若可用）否则回退到 Exa，并成功返回结果。
2. Given max_results=3，When 触发带 Web 搜索的单次请求，Then 模型响应中最多引用3条来源（若有）。
3. Given 上下文规模设为“高”，When 发起请求，Then 响应质量与引用丰度提高（可通过对比基线的人工核验样本集验证）。

---

### User Story 4 - 健壮错误处理与重试 (Priority: P3)

系统仅支持单次交互模式。当提供方不支持或请求失败时，系统自动重试一次，仍失败则直接失败并返回清晰错误；不回退到旧的多轮实现，也不提供模式切换开关。

**Why this priority**: 明确的失败边界和最小化复杂度，避免回退路径引入不一致行为。

**Independent Test**: 人为制造提供方不支持或网络异常，验证系统自动重试一次，仍失败则返回错误并输出可观测日志。

**Acceptance Scenarios**:

1. Given 提供方返回不支持“在线搜索”，When 触发单次模式，Then 系统自动重试一次；若仍失败，则直接失败并返回清晰错误，不回退旧多轮。
2. Given 无任何特性开关，When 调用“搜索+摘要”，Then 始终以单次交互模式执行。

### Edge Cases

- 提供方暂不可用或速率受限（429/5xx）
- 模型响应未包含任何引用注解（处理策略：返回带“无引用”标记、记录详细日志并创建人工复核任务）
- Web 搜索返回空结果或内容质量不佳
- 超时、成本预算限制（请求被取消）
- 非中文/多语言来源的链接与内容混排
- 大上下文输入导致截断风险
- 需要严格引用但模型未产出引用的处理策略

## Requirements (mandatory)

### Functional Requirements

- **FR-001**: 系统必须合并“搜索轮”和“摘要轮”为单次模型请求完成（单轮“搜索+摘要”），可启用 Web 搜索能力；不得再依赖多次与模型往返来补齐搜索与回答。
- **FR-002**: 前端必须支持同时展示综合回答与引用列表（引用以域名命名的可点击链接形式呈现）。
- **FR-003**: 系统必须自动选择 Web 搜索引擎（原生可用则原生，否则 Exa），且不提供引擎相关的用户配置选项。
- **FR-004**: 系统必须支持配置最大搜索结果数（默认5，可在0-10范围内调整）。
- **FR-005**: 系统必须支持搜索上下文规模参数（低/中/高），用于控制检索深度与成本；默认值为“高”。
- **FR-006**: 系统必须解析并结构化存储模型响应中的标准化引用注解（包含 URL、标题、可用时的片段内容、文本位置索引）。
- **FR-007**: 当响应无引用注解时，系统必须仍返回内容并标记“无引用”；同时记录详细可观测日志（包含请求上下文、模型响应原文和解析元数据）并将该条目提交至人工复核队列供后续审计或异步补充。
- **FR-008**: 系统不得保留或暴露旧多轮模式与相关特性开关，仅支持单次交互模式。
- **FR-009**: 当提供方不支持或请求失败时，系统必须先自动重试一次；若仍失败，则直接失败并返回可理解的错误信息；不回退到旧多轮。
- **FR-010**: 系统必须提供可观测信息（请求次数应为1、引擎类型、上下文规模、max_results、是否产出引用、失败原因）。
- **FR-011**: 系统必须保证与现有上游/前端的接口契约保持兼容；如输出结构变更（新增引用字段），需在版本化或向后兼容策略下提供。
- **FR-012**: 系统必须支持按请求覆盖全局默认配置（例如针对特定任务临时设置“高”上下文规模）。
- **FR-013**: 系统必须提供成本与超时保护（超时中止、可配置预算阈值，触发时记录并返回受控错误）。
- **FR-014**: 系统必须提供最小化回归测试覆盖：验证单轮请求、引用解析、配置生效、回退路径、生错路径与可观测日志。
- **FR-015**: 系统必须提供基础中文文档，说明配置项含义与注意事项（尤其是成本/上下文规模/引擎选择）。
- **FR-016**: 时间线与步骤描述需从“搜索→摘要”两步更新为“搜索+摘要”一步，前后端显示与日志中保持一致。
- **FR-017**: 必须立即彻底删除所有旧多轮模式相关代码（后端流程、控制分支、开关与配置项、测试与脚本、CI 检查、环境变量），并在移除前执行完整的备份与回滚验证。
- **FR-018**: 必须同步前端页面与逻辑，移除多轮模式 UI/状态/请求路径，确保“搜索+摘要”单轮的展示（回答与引用）与交互一致。
- **FR-019**: 必须同步存储与数据层，立即删除多轮模式相关的存储字段、索引与读写逻辑并执行一次性迁移/清理任务；在删除前应生成可回放的迁移脚本和完整备份以支持回滚。
- **FR-020**: 必须同步更新文档（README、用户指南、运维说明、PRD/Specs），删除多轮模式说明，补充单轮模式的参数、观测与排错指南。
- **FR-021**: 必须新增一次性数据迁移与回归检查任务，确保删除多轮模式后系统可用；迁移/清理步骤需可回放与可审计。
- **FR-022**: 引用（Citation）应作为独立数据实体存在，并通过外键与 `AnnotatedMessage` 或相关记录关联；必须记录上述字段（见 Key Entities）以支持展示、审计与回溯。

### 決策（由用户确认）

- 引擎默认策略：自动（原生可用则原生，否则 Exa），且不对用户暴露引擎配置项。
- 搜索上下文规模默认：高。
- 失败时回退策略：先重试一次，仍失败则直接失败；不保留旧多轮回退。

### Implementation & Rollout Notes (non-technical audience wording)

- 删除多轮模式：立即在代码库与生产环境中彻底移除多轮相关实现；备份策略为通过 Git 记录与备份（由用户确认已执行）；删除后不保留额外回滚窗口（不可回退）。
- 单轮"搜索+摘要"落地：后端一次请求返回回答与引用；前端统一卡片展示，引用以域名命名链接。
- 存储收敛：保留与引用显示相关的必要结构，移除多轮时序存档结构；对旧数据做迁移/清理。
- 观测统一：日志、埋点与报表以“单轮”口径呈现（请求计数=1、引擎=auto、高上下文默认）。
- 文档同步：开发手册、用户文档、运维文档、变更日志需同步更新；强调失败重试一次后失败即返回。

### Key Entities (include if feature involves data)

- **RoundConfig**: 轮次配置（是否启用 Web 搜索、引擎策略、max_results、上下文规模、超时与预算阈值）。
- **AnnotatedMessage**: 模型响应消息（文本内容与标准化引用注解集合）。
- **Citation**: 引用条目（作为独立实体，字段示例：`url`, `title`, `snippet`（可选）, `start_index`, `end_index`, `domain`, `confidence_score`, `raw_html`, `fetch_timestamp`, `mime_type`, `favicon`）。

### Assumptions

- OpenRouter 提供的 `:online` 或 `plugins: [{ id: "web" }]` 能力可用，并按官方注解模式返回引用。
- 若未指定 `engine`，自动策略将优先使用原生能力，若不可用再回退至 Exa（与官方默认一致）。
- `max_results` 默认 5；当为 0 时仅启用模型但不强制引入外部引用结果。
- 搜索上下文规模取值遵循官方“低/中/高”含义；默认采用“高”。
- 不对用户暴露 Web 引擎的配置项（固定为自动选择）。
- 现有前端对“搜索轮/摘要轮”的展示无需破坏性变更；新增引用字段以向后兼容方式提供。
- 身份验证/认证假设：当前系统仅依赖用户提供的 API KEY，规格不要求更改此行为（保持现状）。

## Success Criteria (mandatory)

### Measurable Outcomes

- **SC-001**: “搜索轮/摘要轮”在默认配置下均以单次模型请求完成（请求计数=1），覆盖率≥99%。
- **SC-002**: P95 端到端时延较旧多轮实现降低≥30%。
- **SC-003**: 当有可用引用时，系统正确解析并保存引用，抽检样本正确率≥95%。
- **SC-004**: 通过配置覆盖测试，所有配置项（引擎、max_results、上下文规模、回退策略）均能生效并被日志观测到。

## Clarifications

### Session 2025-10-26

- Q: 是否应立即彻底删除所有旧多轮模式相关实现还是分阶段退役？ → A: A
- Q: 当模型响应未产出任何引用注解时系统应如何处理？ → A: A
- Q: 身份验证方法应如何处理？ → A: 当前系统没有身份验证功能，仅需要用户填入 API KEY，不要做修改
- Q: 回滚窗口与备份保留策略应如何处理？ → A: A（已通过 git 备份，删除后不保留回滚窗口）
- Q: 引用（Citation）数据模型应如何设计？ → A: C

