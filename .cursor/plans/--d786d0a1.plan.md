<!-- d786d0a1-ac7a-483d-8fcc-bacf2c49f2ef 49d463d2-edde-4ab2-8a66-399271af6135 -->
# 单 agent 评审流程整改计划（采纳：识别轮=a，资料注入=a）

## 现状差距与证据

- 历史未正确进入直评上下文（仅识别 `modelMarkdown/dialog`），需兼容 `{role,content}`。
```49:66:services/circuit-agent/src/app/usecases/DirectReviewUseCase.ts
    try {
      const history = (params.request as any).history || []
      if (Array.isArray(history) && history.length > 0) {
        for (const h of history) {
          const hh = h as any
          if (hh.modelMarkdown) parts.push({ role:'assistant', content:String(hh.modelMarkdown) })
          if (hh.dialog) parts.push({ role:'user', content:String(hh.dialog) })
        }
      }
    } catch {}
```

- 启用检索时虽抓取 `datasheetMeta`/下载资料，但未将“资料文本”注入 LLM，仅作为工件；且没有“关键技术路线清单”识别轮。
```125:171:services/circuit-agent/src/interface/http/routes/orchestrate.ts
// rec.circuit.datasheetMeta → fetchAndSaveDatasheets()，但未将文本摘要注入上下文
```

- 联网搜索仅给 URL 列表，缺少逐URL内容摘要能力。
```14:23:services/circuit-agent/src/infra/search/OpenRouterSearch.ts
// search(query) 仅返回 {title,url}[]
```


## 将达成的目标

- 完整实现你的流程：资料整合 →（可选）识别轮（关键器件/技术路线清单）→ 逐URL在线摘要并保存 → 将每条摘要各自注入一条 system 消息 → 选择初始/修订提示词 → 直评 → 支持用户异议的无限修订循环。
- 清理未用实现，更新 `CURSOR.md` 与中英 `README`，保持一致。

## 具体改动

### 后端（services/circuit-agent）

1) `domain/contracts/index.ts`

- 在 `ReviewRequest` 新增 `extraSystems?: string[]`（中文注释）。

2) `app/usecases/DirectReviewUseCase.ts`

- 修复历史注入：优先识别 `{role,content}`；兼容旧字段 `modelMarkdown/dialog`。
- 支持 `request.extraSystems`：逐条前插入 `system` 消息（位于主 `systemPrompt` 之后、用户消息之前）。
- 其余工件与时间线逻辑保持不变。

3) 新增 `app/usecases/IdentifyKeyFactsUseCase.ts`

- 输入：`apiUrl, model, files, requirements, specs, dialog, language`。
- 使用识别轮提示词（中/英），强制输出 JSON：`{ keyComponents: string[], keyTechRoutes: string[] }`。
- 失败回退为空数组并记录 request/response 工件与 timeline（`identify.request/identify.response`）。

4) 扩展 `infra/search/OpenRouterSearch.ts`

- 新增 `summarizeUrl(url:string, wordLimit:number, lang:'zh'|'en'): Promise<string>`：基于 `openai/gpt-4o:online` 抓取并总结为纯文本，限制≤wordLimit词。

5) 修改 `interface/http/routes/orchestrate.ts`（`directReview` 分支）

- 选择好 `systemPromptToUse`、解析 `language` 与 `history` 后：
  - 若 `enableSearch=true`：

1) 调用 `IdentifyKeyFactsUseCase` 获取 `keyComponents/keyTechRoutes`；

2) 按关键词调用 `OpenRouterSearch.search(q, topN)` 获 URL 列表；

3) 对每个 URL 调用 `summarizeUrl(url, 512, language)` 产出摘要；摘要各自保存为 artifact（如 `summary_*.md`）；

4) 将每条摘要作为一条独立的 `system` 文本加入 `extraSystems`；

5) Token 守卫：每关键词最多取 K 条（默认 K=2，受 `searchTopN` 约束），总摘要条数上限（例如 10）。

  - 调用 `direct.execute` 时在 `request` 中带上 `extraSystems`；保留 `enrichedJson`（若存在）。

6) 提示词

- 新增识别轮提示词：`ReviewAIPrompt/circuit-agent/identify_prompt_zh.md`、`identify_prompt_en.md`。
- 继续使用 `system_prompt_initial_*.md` / `system_prompt_revision_*.md`。

7) 清理

- 删除 `infra/search/DuckDuckGoHtmlSearch.*` 及相关导出/引用；移除不再使用的脚本/常量（逐文件确认）。

### 前端（frontend）

- UI 维持；已传递 `language/enableSearch/history` 字段。
- 可选：在“高级设置”文案补充“启用器件搜索后将自动抓取并注入资料摘要”。

### 文档同步

- 更新 `CURSOR.md` 主体与“变更记录”（识别轮、逐URL摘要注入、history 修复、DuckDuckGo 清理）。
- 更新根 `README.md` 与 `README.zh.md`：加入识别轮与摘要注入说明；提示在 `ReviewAIPrompt/` 新增识别轮提示词。

## 关键代码触点（编辑入口）

- `services/circuit-agent/src/app/usecases/DirectReviewUseCase.ts`
- `services/circuit-agent/src/app/usecases/IdentifyKeyFactsUseCase.ts`（新增）
- `services/circuit-agent/src/interface/http/routes/orchestrate.ts`
- `services/circuit-agent/src/infra/search/OpenRouterSearch.ts`
- `services/circuit-agent/src/domain/contracts/index.ts`
- `ReviewAIPrompt/circuit-agent/identify_prompt_*.md`（新增）

## 风险与约束

- Token/时延：逐URL摘要会增加耗时，已设置 TopN 与总数上限；可通过前端 `searchTopN` 控制。
- 多语言：摘要按 `language` 输出；默认 `zh`。
- 异常处理：遵循你的要求，异常分支不重复嵌套判断。

## 实施待办（执行顺序）

- [ ] fix-history-inclusion：修复 DirectReviewUseCase 历史注入并支持 extraSystems
- [ ] add-identify-usecase：新增 IdentifyKeyFactsUseCase 与识别轮提示词
- [ ] extend-search-provider：OpenRouterSearch 增加 summarizeUrl()
- [ ] orchestrate-flow-update：直评分支串联 识别→检索→摘要→注入→直评
- [ ] token-budget-guard：TopN/K/总上限与长度裁剪
- [ ] cleanup-unused：删除 DuckDuckGo* 与未用代码
- [ ] docs-sync：更新 CURSOR.md 与中英 README

### To-dos

- [ ] 修复 DirectReviewUseCase 对 {role,content} 历史的注入
- [ ] 新增识别轮：生成关键元器件与技术路线 JSON
- [ ] 扩展 OpenRouterSearch 支持 URL 摘要（:online）
- [ ] 在直评前注入资料摘要到上下文并保存工件
- [ ] 加入 TopN 与长度裁剪，防超 Token
- [ ] 重构 orchestrate 直评分支以串联识别→检索→注入→直评
- [ ] 新增/更新识别轮与修订轮提示词（中/英）
- [ ] 前端高级设置文案提示资料摘要注入行为
- [ ] 删除 DuckDuckGoHtmlSearch 及未用代码
- [ ] 同步更新 CURSOR.md 与中英 README